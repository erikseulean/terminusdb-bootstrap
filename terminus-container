#!/bin/bash

#
# CONFIG
#

# Contianer
CONTAINER=${TERMINUS_CONTAINER:-terminus-server}
REPOSITORY=${TERMINUS_REPOSITORY:-terminusdb/terminus-server}
TAG=${TERMINUS_TAG:-latest} 

# Volumes
TERMINUS_STORAGE=${TERINUS_TERMINUS_STORAGE:-terminus_storage}
TERMINUS_CONFIG=${TERMINUS_TERMINUS_CONFIG:-terminus_config}
STORAGE_VOLUME=${TERMINUS_STORAGE_VOLUME:-/app/terminusdb/storage}
CONFIG_VOLUME=${TERMINUS_CONFIG_VOLUME:-/app/terminusdb/config}


# Server
SERVER=${TERMINUS_SERVER:-localhost}
PORT=${TERMINUS_PORT:-6363}
WORKERS=${TERMINUS_WORKERS:-8}
PASS=${TEMRINUS_PASS:-root}
CONSOLE=http://$SERVER:$PORT${TERMINUS_CONSOLE:-/console}

if command -v sudo >/dev/null;
then
  DOCKER="sudo docker"
else
  DOCKER="docker"
fi

#
# FUNCTIONS
#

_usage () {
  printf "\
USAGE:
  terminus-container [COMMAND]

  help      show usage
  run       run container
  stop      stop container
  console   launch console in web browser
  attach    attach to prolog shell
  stats     show container stats
  rm        remove volumes\n"
}

_confirm() {
  read -r -p "Are you sure? [y/N] " RESPONSE
  case "$RESPONSE" in
      [yY][eE][sS]|[yY]) 
          return 0
      ;;
      *)
          return 1
      ;;
  esac
  printf "\n"
}

_run () {
  $DOCKER image rm $REPOSITORY:$TAG 2>/dev/null
  $DOCKER run -d -it --rm \
    --name $CONTAINER -p $PORT:$PORT \
    -v $TERMINUS_STORAGE:$STORAGE_VOLUME:rw \
    -v $TERMINUS_CONFIG:$CONFIG_VOLUME:rw \
    -e SERVER_NAME=$SERVER \
    -e SERVER_PORT=$PORT \
    -e WORKERS=$WORKERS \
    -e DB_PASS=$PASS \
    $REPOSITORY:$TAG
}

_stop () {
  $DOCKER stop $CONTAINER
}

_restart () {
  $DOCKER stop $CONTAINER
}

_attach () {
  $DOCKER attach $CONTAINER
}

_stats () {
  $DOCKER stats $CONTAINER
}

_rm () {
 if _confirm
 then
   $DOCKER volume rm "$TERMINUS_STORAGE" \
   && $DOCKER volume rm "$TERMINUS_CONFIG"
 fi
}

_console () {
  python -m webbrowser "$CONSOLE"
}

#
# PROCESS ARGS
#

printf "\n"

if [ ! -z "$1" ]; then
  case "$1" in
    "run")
      # _build
      _run > /dev/null \
        && printf "terminus-server container started $CONSOLE\n" \
        || printf "\nIs the container already running?\n"
    ;;
    "stop")
      _stop > /dev/null \
        && printf "terminus-server container stopped\n" \
        || printf "\nIs the container running?\n"
    ;;
    "console")
      _console \
        || printf "this command requires python\n"
    ;;
    "attach")
      printf "Ctrl+p Ctrl+q to detach\n\n"
      _attach
    ;;
    "stats")
      _stats \
        || printf "\nIs the container running?\n"
    ;;
    "rm")
      printf "removing will delete storage and config volumes\n"
      _rm \
        || printf "\nIs the container stopped?\n"
    ;;
    "help")
      _usage
    ;;
    *)
      printf "invalid command\n\n"
      _usage
    ;;
  esac
else
  _usage
fi

printf "\n"

# vim:ft=sh
